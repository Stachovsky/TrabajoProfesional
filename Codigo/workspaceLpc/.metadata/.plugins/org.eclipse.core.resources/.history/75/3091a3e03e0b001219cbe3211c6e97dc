/*
 * PcCommunication.c
 *
 *  Created on: Sep 26, 2012
 *      Author: Facundo Nahuel Uriel Silva
 */

#include "taskPcCommunication.h"

///////////////////////////////////////////////////////////////////////////////////////////////
// Colas de mensajes
///////////////////////////////////////////////////////////////////////////////////////////////

xQueueHandle queuePcComTX;
xQueueHandle queuePcComRX;

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

void taskPcCommunicationInit(){

	// Se inicializa la uart 3
	API_UartConfig(UART_PORT_3, interruptUart3);

	// Se inicializa la cola de mensajes de transmision
	queuePcComTX = xQueueCreate( MAX_SIZE_QUEUE_TX, sizeof( msgPcCom ) );

	// Se inicializa la cola de mensajes de recepcion
	queuePcComRX = xQueueCreate( MAX_SIZE_QUEUE_RX, sizeof( msgPcCom ) );

}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

void taskPcCommunicationTX(void *param){

	msgPcCom	tempRecieve;
	uint8_t		str[30];

	while (1) {

		if(uxQueueMessagesWaiting(queuePcComTX)){ // se espera hasta que la cola tenga mensajes

			// se intenta leer un mensaje de la cola. El numero de elementos en la cola se decrementa en 1
			if(xQueueReceive(queuePcComTX,&tempRecieve,1000)){

				sprintf(str,"%.3d", tempRecieve.idMsg);
				API_UartSendString(UART_PORT_3,str);

			}else{
				taskYIELD();
			}
		}
	}

}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

void taskPcCommunicationRX(void *param){

	while (1) {
		taskYIELD();
	}
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

void interruptUart3(uint8_t c){

	uint8_t temp[15];
	API_UartDisableInterrupt(UART_PORT_3);

	sprintf((char*)temp, "llego %c\r\n", (char)c);
	API_UartSendString(UART_PORT_3,temp);

	API_UartEnableInterrupt(UART_PORT_3);
}

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
